<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–æ–∑–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–≤–æ—Ä–¥–∞</title>
    <link rel="stylesheet" href="/css/styles.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.5.0-beta4/html2canvas.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f0f0;
            margin: 0;
        }

        .form-container {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            max-width: 800px;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .form-body {
            display: flex;
            flex-direction: row; /* –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞ row –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –∏ —Å–µ—Ç–∫–∏ —Ä—è–¥–æ–º */
            align-items: flex-start; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –≤–µ—Ä—Ö–Ω–µ–º—É –∫—Ä–∞—é */
            justify-content: left; /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ */
            flex-grow: 1; /* –≠—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∑–≤–æ–ª—è—é—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º –∑–∞–Ω–∏–º–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ */
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
            margin-right: 20px;
        }

        .grid {
            display: grid;
            gap: 1px;
            margin-left: 20px; /* –û—Ç—Å—Ç—É–ø –æ—Ç –∫–Ω–æ–ø–æ–∫ */
            margin-top: 20px; /* –û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É */
            justify-self: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–∫–∏ –≤ –µ—ë –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ */
        }

        .cell {
            border: 1px solid #ccc;
            width: 25px;
            height: 25px;
            background-color: white;
            transition: background-color 0.2s ease; /* –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ —Ü–≤–µ—Ç–∞ */
            text-align: center;
        }

        .preview-highlight {
            background-color: rgba(0, 0, 255, 0.5);
        }

        .highlight {
            background-color: blue;
        }

        .answer-preview:hover {
            background-color: rgba(255, 0, 0, 0.5);
        }

        .answer-final {
            background-color: red;
        }
        .controls button {
            margin-bottom: 5px;
        }
        .delete-highlight {
            outline: 2px solid red; /* –ö—Ä–∞—Å–Ω–∞—è —Ä–∞–º–∫–∞ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è */
        }
        .item-type, .item-answer{
            cursor: pointer;
        }
        .texted
        {
            background-color: white;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
        .modal {
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            position: fixed; /* –û—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ */
            z-index: 1; /* –ü–æ–≤–µ—Ä—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
            left: 0;
            top: 0;
            width: 100%; /* –®–∏—Ä–∏–Ω–∞ 100% */
            height: 100%; /* –í—ã—Å–æ—Ç–∞ 100% */
            overflow: auto; /* –î–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–æ–∫—Ä—É—Ç–∫—É, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ */
            background-color: rgba(0, 0, 0, 0.4); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω */
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 300px; /* –®–∏—Ä–∏–Ω–∞ –æ–∫–Ω–∞ */
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .checkmark {
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            font-size: 24px;
            position: absolute; /* –ü–æ–∑–∏—Ü–∏—é –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ */
            bottom: 20px; /* –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ—Ç –Ω–∏–∂–Ω–µ–π —á–∞—Å—Ç–∏ —ç–∫—Ä–∞–Ω–∞ */
            right: 10px;
            transition: opacity 0.5s ease;
            padding: 10px; /* –û—Ç—Å—Ç—É–ø—ã –¥–ª—è —Ñ–æ–Ω–∞ */
            border-radius: 5px; /* –ó–∞–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤ */
        }
    </style>
</head>
<body>
<div class="form-container">
    <h2>–°–æ–∑–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–≤–æ—Ä–¥–∞</h2>
    <div class="form-body">
        <div class="controls">
            <button onclick="addWord()">–î–æ–±–∞–≤–∏—Ç—å</button>
            <button onclick="saveScanword()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="back" onclick="enableDelete()">–£–¥–∞–ª–∏—Ç—å —Å–ª–æ–≤–æ</button>
            <button class="back" onclick="goBack()">–ù–∞–∑–∞–¥</button>
        </div>
        <div id="scanwordGrid" class="grid">

        </div>
        <div class="word-container">
            <div class="word-list" id="wordList">
                <!-- –°–ª–æ–≤–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ —Å–ª–æ–≤–∞ -->
<div id="myModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3>–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –∏ –æ—Ç–≤–µ—Ç</h3>
        <label for="question">–í–æ–ø—Ä–æ—Å:</label><br>
        <input type="text" id="question" required><br><br>
        <label for="answer">–û—Ç–≤–µ—Ç:</label><br>
        <input type="text" id="answer" required><br><br>
        <button id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
</div>

<div id="checkmark" class="checkmark"></div>

<script>
    let scanwordName = null;
    let width = null;
    let height = null;
    let dictionaryId = null;;
    let sc_data = [];
    let numberOfHints = null;
    const maxLineLength = 10;
    const minLineLength = 2;
    let dictionaryData = [];
    let images = [];
    let melodies = [];
    let isMouseDown = false;
    let startCell = null;
    let selectedCells = [];
    let answerPreviewCells = [];
    let lastFinalCells = [];
    let answerAdded = true;
    let deleteMode = false;
    let currentID = 1;
    let choosen = true
    let scanwordId = null;

    document.addEventListener('DOMContentLoaded', async function () {
        await getData();
        document.title = `–°–∫–∞–Ω–≤–æ—Ä–¥: ${scanwordName}`;
        createGrid(width, height);
        document.addEventListener('mousedown', handleMouseDown);
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        document.addEventListener('keydown', handleKeyDown);

    });

    async function getData()
    {
        await fetch('scanword/not_created',{
            method: 'GET',
            headers: {
                'Content-Type': 'application/json' // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏—Ç–µ —Ç–∏–ø —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
            }
        }).then(response => response.json())
            .then(scanword =>{
            console.log(scanword);
            scanwordId = scanword.id;
            dictionaryId = scanword.dictionaryId;
            scanwordName = scanword.name;
            width = scanword.width;
            height = scanword.height;
            scanword.content.forEach(cell => sc_data.push(cell));
            numberOfHints = scanword.numberOfHints;
        });
        try
        {
            const response = await fetch('/create_api/' + dictionaryId);
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            const dataAll = await response.json();
            dictionaryData = dataAll.data.dictionaryData;
            images = dataAll.data.images;
            melodies = dataAll.data.melodies;
        }
        catch (error)
        {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
        }
    }

    function createGrid(cols, rows) {
        const grid = document.getElementById('scanwordGrid');
        grid.style.gridTemplateColumns = `repeat(${cols}, 25px)`;
        grid.style.gridTemplateRows = `repeat(${rows}, 25px)`;
        grid.innerHTML = '';

        for (let i = 0; i < rows; i++) {
            for (let j = 0; j < cols; j++) {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                cell.dataset.row = i;
                cell.dataset.col = j;
                grid.appendChild(cell);
            }
        }
        for (const dataCell of sc_data) {
            const row = dataCell.row;
            const col = dataCell.col;
            const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
            if (cell)
            {
                if(dataCell.task)
                {
                    cell.classList.add("answer-final");
                    cell.dataset.word = dataCell.word;
                    cell.textContent = dataCell.taskType === "VERBAL"? 'üìÑ' : ( dataCell.taskType === "IMAGE"? 'üñºÔ∏è' : 'üéµ');
                }
                else
                {
                    if(dataCell.letter !== null)
                    {
                        cell.classList.add("highlight");
                        cell.classList.add("texted");
                        cell.textContent = dataCell.letter;
                    }
                }
            }
        }
    }

    function saveScanword() {
        let cells = document.querySelectorAll(`.cell`);
        let scanwordData = [];
        let isCompleted = null;
        cells.forEach(cell => {
            let row = cell.dataset.row;;
            let col = cell.dataset.col;;
            let letter = null;
            let task = null;
            let taskType = null;
            let word = null;
            if(cell.classList.contains('answer-final') || cell.classList.contains('highlight'))
            {
                isCompleted = true;
                task = cell.classList.contains('answer-final'); // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —è—á–µ–π–∫–∞ –∑–∞–¥–∞–Ω–∏–µ–º
                if (task) {
                    // –ï—Å–ª–∏ —è—á–µ–π–∫–∞ —è–≤–ª—è–µ—Ç—Å—è –∑–∞–¥–∞–Ω–∏–µ–º, –ø–æ–ª—É—á–∞–µ–º —Ç–∏–ø –∏ ID
                    taskType = cell.textContent === 'üìÑ'? "VERBAL" : (cell.textContent === 'üñºÔ∏è'? "IMAGE" : "MELODY");
                    word = cell.dataset.word;
                }
                else
                {
                    letter = cell.textContent;
                }
            }
            else{
                isCompleted = false;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —è—á–µ–π–∫–∏ –≤ –º–∞—Å—Å–∏–≤
            scanwordData.push({
                row: row,
                col: col,
                letter: letter,
                task: task,
                taskType: taskType,
                word: word
            });
            if(!task)
            {
                cell.textContent = "";
            }
        });
        const grid = document.getElementById('scanwordGrid'); // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—Ç–∏–º —Å–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–º
        // –°–æ–∑–¥–∞—ë–º —Å–∫—Ä–∏–Ω—à–æ—Ç
        html2canvas(grid).then(canvas => {
            // –ü–æ–ª—É—á–∞–µ–º Blob –∏–∑ canvas
            canvas.toBlob(function(blob) {
                // –¢–µ–ø–µ—Ä—å blob –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–π—Ç–æ–≤–æ–≥–æ –º–∞—Å—Å–∏–≤–∞
                const reader = new FileReader();
                reader.onload = function(event) {
                    const preview = new Uint8Array(event.target.result); // –ü–æ–ª—É—á–∞–µ–º –±–∞–π—Ç–æ–≤—ã–π –º–∞—Å—Å–∏–≤
                    // –¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç scanwordDto
                    const scanwordDto = {
                        name: localStorage.getItem('scanwordName'),  // –ò–º—è —Å–∫–∞–Ω–≤–æ—Ä–¥–∞
                        width: +localStorage.getItem('scanwordWidth'), // –®–∏—Ä–∏–Ω–∞
                        height: +localStorage.getItem('scanwordHeight'), // –í—ã—Å–æ—Ç–∞
                        preview: Array.from(preview), // –ü—Ä–µ–≤—å—é
                        dictionaryId: localStorage.getItem('dictionaryId'), // ID —Å–ª–æ–≤–∞—Ä—è
                        content: scanwordData, // –°–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ —è—á–µ–π–∫–∞—Ö
                        isCreated: isCompleted, // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–µ–Ω –ª–∏ —Å–∫–∞–Ω–≤–æ—Ä–¥
                        numberOfHints: localStorage.getItem('hintsCount') // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥—Å–∫–∞–∑–æ–∫, –µ—Å–ª–∏ –µ—Å—Ç—å
                    };
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ fetch
                    fetch(`/scanword?id=${scanwordId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(scanwordDto)
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + response.statusText);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('–°–∫–∞–Ω–≤–æ—Ä–¥ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω:', data);
                            alert('–°–∫–∞–Ω–≤–æ—Ä–¥ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
                            window.location.href = "/";
                        })
                        .catch(error => {
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–∫–∞–Ω–≤–æ—Ä–¥–∞:', error);
                            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–∫–∞–Ω–≤–æ—Ä–¥–∞.');
                        });
                };
                // –ß–∏—Ç–∞–µ–º blob –∫–∞–∫ ArrayBuffer
                reader.readAsArrayBuffer(blob);
            }, 'image/png'); // –ó–∞–¥–∞–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        }).catch(error => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞:', error);
        });
    }

    const modal = document.getElementById("myModal");
    const saveBtn = document.getElementById("saveBtn");
    const checkmark = document.getElementById("checkmark");

    function addWord() {
        modal.style.display = "block";
    }
    function closeModal() {
        modal.style.display = "none";
    }

    window.onclick = function (event) {
        if (event.target === modal) {
            closeModal();
        }
    };
    saveBtn.onclick = async function () {
        const question = document.getElementById('question').value.trim();
        const answer = document.getElementById('answer').value.trim().toUpperCase();
        if (question && answer && !answer.split('').every(char => '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ'.includes(char)))
        {
            dictionaryData.push({ word: answer, definition : question,type: 'text' });
            fetch(`dictionary/${dictionaryId}?word=${answer}&definition=${question}&operation=1`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json' // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏—Ç–µ —Ç–∏–ø —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
                }
            }).then(responce => {
                if(responce.ok)
                {
                    console.log("–°–ª–æ–≤–æ –±—ã–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!");
                    getWords();
                }
                else
                {
                    console.error("–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫!");
                }
            });
            showCheckmark("‚úî");
            document.getElementById('question').value = '';
            document.getElementById('answer').value = '';
            closeModal();
        } else {
            showCheckmark("‚ùå");
        }
    }

    function showCheckmark(val) {
        checkmark.textContent = val;
        if(val === "‚úî")
        {
            checkmark.style.color = "green";
            checkmark.style.backgroundColor = "rgba(50, 205, 50, 0.8)";;
        }
        else
        {
            checkmark.style.color = "red";
            checkmark.style.backgroundColor = "rgba(255, 69, 58, 0.8)";
        }
        checkmark.style.display = "block"; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–∞–ª–æ—á–∫—É
        checkmark.style.opacity = "1"; // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≥–∞–ª–æ—á–∫–∞ –≤–∏–¥–∏–º–∞
        setTimeout(() => {
            checkmark.style.opacity = "0"; // –°–∫—Ä—ã–≤–∞–µ–º –≥–∞–ª–æ—á–∫—É
            setTimeout(() => {
                checkmark.style.display = "none"; // –£–±–∏—Ä–∞–µ–º –≥–∞–ª–æ—á–∫—É –∏–∑ DOM
            }, 500); // –ñ–¥–µ–º, –ø–æ–∫–∞ –∏—Å—á–µ–∑–Ω–µ—Ç, –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º –∏–∑ DOM
        }, 2000); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞ 1.5 —Å–µ–∫—É–Ω–¥—ã
    }

    function goBack() {
        window.history.back();
    }
    function enableDelete() {
        deleteMode = !deleteMode; // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —É–¥–∞–ª–µ–Ω–∏—è
        alert(deleteMode ? '–†–µ–∂–∏–º —É–¥–∞–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–ª–µ—Ç–∫–∏ –¥–ª—è –∏—Ö —É–¥–∞–ª–µ–Ω–∏—è.' : '–†–µ–∂–∏–º —É–¥–∞–ª–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω.');
    }

    function handleMouseDown(event) {
        const cell = event.target.closest('.cell');
        if (!cell) return;
        if (deleteMode) {
            selectForDelete(cell);
            return;
        }
        if (!cell.classList.contains('answer-final') && !cell.classList.contains('answer-preview') && choosen && answerAdded) {
            answerAdded = false;
            choosen = false;
            lastFinalCells = [];
            isMouseDown = true;
            startCell = cell;
            selectedCells = [cell];  // –ù–∞—á–∏–Ω–∞–µ–º —Å –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π —è—á–µ–π–∫–∏
            highlightPreview(selectedCells);
        }
    }

    function handleMouseMove(event) {
        if (!isMouseDown) return;
        const cell = event.target.closest('.cell');

        if (!cell) return;

        const rowStart = parseInt(startCell.dataset.row);
        const colStart = parseInt(startCell.dataset.col);
        const rowCurrent = parseInt(cell.dataset.row);
        const colCurrent = parseInt(cell.dataset.col);

        let newCellsToHighlight = [];

        if (rowStart === rowCurrent && colStart <= colCurrent) { // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            newCellsToHighlight = highlightCells(rowStart, colStart, colCurrent);
        } else if (colStart === colCurrent && rowStart <= rowCurrent) { // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            newCellsToHighlight = highlightCells(colCurrent, rowStart, rowCurrent, true);
        }

        // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∏–∑ —Ä–∞–Ω–µ–µ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö —è—á–µ–µ–∫, –µ—Å–ª–∏ –æ–Ω–∏ –±–æ–ª—å—à–µ –Ω–µ –≤ –Ω–æ–≤–æ–π –≤—ã–±–æ—Ä–∫–µ
        selectedCells.forEach(cell => {
            if (!newCellsToHighlight.includes(cell)) {
                cell.classList.remove('preview-highlight');
                selectedCells.pop();
            }
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ —è—á–µ–π–∫–∏
        newCellsToHighlight.forEach(cell => {
            if (!selectedCells.includes(cell)) {
                selectedCells.push(cell);
                cell.classList.add('preview-highlight');
            }
        });
    }

    function selectForDelete(cell) {
        const cellClasses = Array.from(cell.classList).filter(cls => cls.startsWith('id-'));
        if (cellClasses.length > 0) {
            let cellIdToRemove;
            if(cell.classList.contains('highlight'))
            {
                cellIdToRemove = cellClasses[cellClasses.length - 1]; // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ highlight –∫–ª–µ—Ç–∫–∏ (–≤—Å–µ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç)
            }
            else
            {
                cellIdToRemove = cellClasses[0]; // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–µ—Ä–≤—ã–π –∫–ª–∞—Å—Å –∫–∞–∫ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
            }
            // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∫–ª–µ—Ç–∫–∏ —Å —Ç–µ–º –∂–µ id
            const allCellsToRemove = document.querySelectorAll(`.cell.${cellIdToRemove}`);

            allCellsToRemove.forEach(c => {
                c.classList.remove(cellIdToRemove); // –£–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ id
                // –£–¥–∞–ª—è–µ–º 'answer-final' –∏ 'highlight' —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É –∫–ª–µ—Ç–∫–∏ 1 id
                if (c.classList.length === 2) {
                    c.classList.remove('answer-final');
                    c.textContent = "";
                }
                if(c.classList.length === 3){
                    c.classList.remove('highlight', "texted");
                    c.textContent = "";
                }
            });
        }
    }

    function highlightCells(fixed, start, end, isVertical = false) {
        let cellsToHighlight = [];
        for (let i = Math.min(start, end); i <= Math.max(start, end); i++) {
            let cell = isVertical
                ? document.querySelector(`[data-row="${i}"][data-col="${fixed}"]`)
                : document.querySelector(`[data-row="${fixed}"][data-col="${i}"]`);
            if (!cell.classList.contains('answer-final') && !cell.classList.contains('answer-preview')) {
                cellsToHighlight.push(cell);
            } else {
                break;
            }
        }
        return cellsToHighlight.length <= maxLineLength ? cellsToHighlight : [];
    }

    function clearPreview() {
        const highlightedCells = document.querySelectorAll('.preview-highlight');
        highlightedCells.forEach(cell => cell.classList.remove('preview-highlight'));
        answerPreviewCells.forEach(cell => {
            cell.classList.remove('answer-preview');
        });
        answerAdded = true;
        choosen = true;
    }

    function highlightPreview(cells) {
        cells.forEach(cell => {
            if (!cell.classList.contains('highlight')) {
                cell.classList.add('preview-highlight'); // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            }
        });
    }

    function handleMouseUp() {
        if (!isMouseDown) return;
        isMouseDown = false;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥–ª–∏–Ω—É –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π –ª–∏–Ω–∏–∏
        if (selectedCells.length >= minLineLength && selectedCells.length <= maxLineLength) {
            selectedCells.forEach(cell => {
                cell.classList.remove('preview-highlight');
                cell.classList.add('highlight');
                cell.classList.add(`id-${currentID}`);
            });
            readyForAnswerPreview();
        } else {
            clearPreview();
            selectedCells = [];
        }
    }

    function readyForAnswerPreview() {
        const startRow = parseInt(startCell.dataset.row);
        const startCol = parseInt(startCell.dataset.col);

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–ª–µ—Ç–∫–∏ answer-preview –≤–æ–∫—Ä—É–≥ –Ω–∞—á–∞–ª—å–Ω–æ–π –∫–ª–µ—Ç–∫–∏ –∏ –¥–∏–∞–≥–æ–Ω–∞–ª—å–Ω–æ
        for (let i = -1; i <= 1; i++) {
            for (let j = -1; j <= 1; j++) {
                if (Math.abs(i) + Math.abs(j) === 1 || (i !== 0 && j !== 0)) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –¥–∏–∞–≥–æ–Ω–∞–ª–∏
                    const neighborCell = document.querySelector(`[data-row="${startRow + i}"][data-col="${startCol + j}"]`);
                    if (neighborCell && !neighborCell.classList.contains('highlight') && !neighborCell.classList.contains('answer-final')) {
                        neighborCell.classList.add('answer-preview');
                        answerPreviewCells.push(neighborCell);
                    }
                }
            }
        }
    }

    function handleKeyDown(event) {
        if (event.key === 'Escape') {
            removeLastFinalCell();
            clearAllSelections();
        }
    }

    function clearAllSelections() {
        clearPreview();
        if(startCell != null)
            selectForDelete(startCell);
        selectedCells.forEach(cell => {
            cell.classList.remove("highlight");
        })
        selectedCells = [];
        answerPreviewCells = [];
        startCell = null;
    }

    function removeLastFinalCell() {
        if (lastFinalCells.length > 0) {
            const lastCell = lastFinalCells.pop();
            lastCell.classList.remove('answer-final');
            lastCell.textContent = "";
            lastCell.removeAttribute('data-word');
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è –ø–æ –ø—É—Å—Ç—ã–º –∫–ª–µ—Ç–∫–∞–º answer-preview
    document.getElementById('scanwordGrid').addEventListener('click', (event) => {
        const cell = event.target.closest('.cell');
        if (!cell) return;

        if (cell.classList.contains('answer-preview')) {
            answerAdded = true;
            cell.classList.add('answer-final');
            cell.classList.add(`id-${currentID}`);
            lastFinalCells.push(cell);
            getWords();
            currentID++;
            clearPreview(); // –í–æ–∑–≤—Ä–∞—Ç –∫ –ø—É–Ω–∫—Ç—É 1 –±–µ–∑ —Å–±—Ä–æ—Å–∞
        }
    });

    function getWords() {
        let regex = "";
        selectedCells.forEach(cell =>{
            if(cell.textContent === "")
            {
                regex += ".";
            }
            else
            {
                regex += cell.textContent;
            }
        });
        const requestData = {
            dictionaryData: dictionaryData,
            images: images,
            melodies: melodies
        };
        fetch(`/create_api?regex=${regex}`,{
            method: 'POST',
            headers: {
                'Content-Type': 'application/json' // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏—Ç–µ —Ç–∏–ø —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
            },
            body: JSON.stringify(requestData) // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ JSON
        }) // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            .then(response => response.json())
            .then(data => {
                console.log("–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:", data); // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ data –∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–ª—é—á–∏
                if (data && data.data) {
                    const f_dictionaryData = data.data.dictionaryData || []; // –ò–∑–≤–ª–µ–∫–∞–µ–º dictionaryData –∏–ª–∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
                    const f_images = data.data.images || []; // –ò–∑–≤–ª–µ–∫–∞–µ–º images –∏–ª–∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
                    const f_melodies = data.data.melodies || []; // –ò–∑–≤–ª–µ–∫–∞–µ–º melodies –∏–ª–∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤

                    // –¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ displayWords
                    displayWords(f_dictionaryData, f_images, f_melodies);
                    console.log("displayWords() –æ—Ç—Ä–∞–±–æ—Ç–∞–ª.")
                } else {
                    console.error("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:", data);
                }
            })
            .catch(error => console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ª–æ–≤:", error));
    }

    function displayWords(f_dictionaryData, f_images, f_melodies) {
        const wordList = document.getElementById('wordList');
        wordList.innerHTML = ''; // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

        // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ø–∏—Å–∫–∞ —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π
        const container = document.createElement('div');
        container.style.overflowY = 'scroll';
        container.style.maxHeight = '300px'; // –í—ã—Å–æ—Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π
        container.style.border = '1px solid #ccc'; // –û–±–≤–æ–¥–∫–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

        // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        const header = document.createElement('div');
        header.innerHTML = `
        <div style="display: flex; justify-content: space-between; cursor: pointer;">
            <div id="answerHeader" style="flex: 1;"><strong>–û—Ç–≤–µ—Ç</strong></div>
            <div id="typeHeader" style="flex: 1;"><strong>–¢–∏–ø</strong></div>
        </div>
    `;

        const items = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤

        // –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å–ª–æ–≤, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –º–µ–ª–æ–¥–∏–π
        f_dictionaryData.forEach(item => {
            items.push({ answer: item.word, definition : item.definition,type: 'text' });
        });

        f_images.forEach(img => {
            items.push({ answer: img.answer.toUpperCase(), imgSrc: img.base64Image, type: 'image', id: img.id});
        });

        f_melodies.forEach(melody => {
            items.push({ answer: melody.answer.toUpperCase(), name: melody.name, melody64: melody.melody, type: 'audio', id: melody.id});
        });

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        let answerSortDirection = true; // true - –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é, false - –ø–æ —É–±—ã–≤–∞–Ω–∏—é
        let typeSortDirection = true;

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        const renderItems = (itemsToRender) => {
            container.innerHTML = ''; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–¥ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º
            itemsToRender.forEach(item => {
                const wordItem = document.createElement('div');
                wordItem.classList.add('word-item');
                const icon = item.type === 'text' ? 'üìÑ' : item.type === 'image' ? 'üñºÔ∏è' : 'üéµ';

                wordItem.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span class="item-answer">${item.answer}</span>
                    <span class="item-type" >${icon}</span>
                </div>
                <div class="item-details" style="display: none;"></div>
            `;

                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∏–∫–æ–Ω–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏
                wordItem.querySelector('.item-type').addEventListener('click', () => {
                    const detailsDiv = wordItem.querySelector('.item-details');
                    if (item.type === 'text') {
                        detailsDiv.innerHTML = item.definition; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç
                    } else if (item.type === 'image') {
                        detailsDiv.innerHTML = `<img src="${item.imgSrc}" alt="${item.answer}" style="max-width: 100px;"/>`; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    } else if (item.type === 'audio')
                    {
                        const base64Melody = item.melody64;
                        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º base64 –≤ –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                        const byteCharacters = atob(base64Melody);
                        const byteNumbers = new Uint8Array(byteCharacters.length);
                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        const audioBlob = new Blob([byteNumbers], {type: 'audio/mpeg'}); // –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø –∞—É–¥–∏–æ
                        const audioURL = URL.createObjectURL(audioBlob);
                        detailsDiv.innerHTML = `
                        <span>${item.name}</span>
                        <audio controls>
                            <source src="${audioURL}" type="audio/mpeg">
                            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ.
                        </audio>
                    `;
                    }
                    detailsDiv.style.display = detailsDiv.style.display === 'none' ? 'block' : 'none'; // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å
                });
                wordItem.querySelector('.item-answer').addEventListener('click', () =>
                {
                    let icon = '';
                    let itemID = null;
                    if (item.type === 'text') {
                        icon = 'üìÑ'; // –ò–∫–æ–Ω–∫–∞ —Ç–µ–∫—Å—Ç–∞
                    } else if (item.type === 'image') {
                        icon = 'üñºÔ∏è'; // –ò–∫–æ–Ω–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        itemID = item.id;
                    } else if (item.type === 'audio') {
                        itemID = item.id;
                        icon = 'üéµ'; // –ò–∫–æ–Ω–∫–∞ –∞—É–¥–∏–æ
                    }
                    let answerCell = lastFinalCells.pop();
                    lastFinalCells.push(answerCell);
                    answerCell.textContent = icon;
                    const arr = [];
                    for (let i = 0; i <= selectedCells.length; i++) {
                        arr.push(item.answer[selectedCells.length - i]);
                    }
                    answerCell.dataset.word = "";
                    selectedCells.forEach((cell) => {
                        let c = arr.pop();
                        cell.textContent = c;
                        cell.classList.add("texted");
                        answerCell.dataset.word += c;
                    });
                    choosen = true;
                });
                container.appendChild(wordItem);
            });
        };

        // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        items.sort((a, b) => a.answer.localeCompare(b.answer));
        renderItems(items);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º
        header.querySelector('#answerHeader').addEventListener('click', () => {
            items.sort((a, b) => answerSortDirection ? b.answer.localeCompare(a.answer) : a.answer.localeCompare(b.answer));
            answerSortDirection = !answerSortDirection; // –ú–µ–Ω—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            renderItems(items);
        });

        header.querySelector('#typeHeader').addEventListener('click', () => {
            items.sort((a, b) => {
                if (a.type === b.type) return 0;
                return (typeSortDirection ? a.type.localeCompare(b.type) : b.type.localeCompare(a.type));
            });
            typeSortDirection = !typeSortDirection; // –ú–µ–Ω—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            renderItems(items);
        });

        wordList.appendChild(header);
        wordList.appendChild(container);
    }
</script>
</body>
</html>
